name: Scheduled Ping Agent

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # Run every hour at minute 0

jobs:
  scheduled-ping-agent:
    name: Scheduled Ping Agent Execution
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: true

      - name: Setup Java 25 with GraalVM
        uses: actions/setup-java@v5
        with:
          distribution: 'graalvm'
          java-version: '25'

      - name: Setup jbang
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 5
          command: |
            curl -Ls https://sh.jbang.dev | bash -s - app setup
            echo "$HOME/.jbang/bin" >> $GITHUB_PATH

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Execute Bash command
        continue-on-error: true
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GITHUB_ACTIONS: true
        run: |
          chmod +x .github/scripts/execute-and-measure.sh
          ./.github/scripts/execute-and-measure.sh churrera-recipes/hello-world-bash/workflow.xml "bash"

      - name: Check Internet Connectivity
        continue-on-error: true
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GITHUB_ACTIONS: true
        run: |
          chmod +x .github/scripts/execute-and-measure.sh
          ./.github/scripts/execute-and-measure.sh churrera-recipes/check-internet-connectivity/workflow.xml "curl io"

      - name: Execute Java 25 Update Workflow
        continue-on-error: true
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GITHUB_ACTIONS: true
        run: |
          chmod +x .github/scripts/execute-and-measure.sh
          ./.github/scripts/execute-and-measure.sh churrera-recipes/java-25-update/workflow.xml "debian package"

      - name: Execute Hello World Java Workflow
        continue-on-error: true
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GITHUB_ACTIONS: true
        run: |
          chmod +x .github/scripts/execute-and-measure.sh
          ./.github/scripts/execute-and-measure.sh churrera-recipes/hello-world-java/workflow.xml "java hello world"

      - name: Trigger Cleanup Cursor Branches Workflow
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run cleanup-cursor-branches.yaml --ref main